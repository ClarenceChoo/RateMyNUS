# RateMyNUS Firebase Backend

This is the backend service for RateMyNUS, built with Firebase Cloud Functions and Python. It provides serverless API endpoints for the RateMyNUS platform.

## Tech Stack

- **Runtime**: Python 3.13
- **Framework**: Firebase Functions for Python
- **Cloud Platform**: Google Cloud Functions (Firebase)
- **Key Dependencies**:
  - `firebase-admin` - Firebase Admin SDK
  - `firebase-functions` - Cloud Functions framework
  - `flask` - Web framework
  - `flask-cors` - Cross-Origin Resource Sharing support
  - Google Cloud Services (Firestore, Storage)

## Project Structure

```
backend/
├── firebase.json          # Firebase configuration
├── firestore.indexes.json # Firestore composite indexes
├── data/                  # Seed data JSON files
│   ├── canteen.json      # Canteen entities (16 items)
│   ├── dorm.json         # Dormitory entities (16 items)
│   └── classroom.json    # Classroom entities (39 items)
├── scripts/               # Utility scripts
│   ├── seed_canteen.py   # Seed canteen data (IDs: C01-C16)
│   ├── seed_dorm.py      # Seed dorm data (IDs: D01-D16)
│   ├── seed_classroom.py # Seed classroom data (IDs: CR001-CR039)
│   ├── delete_entities.py # Delete all entities
│   └── export_entities.py # Export entities to JSON
├── functions/
│   ├── main.py           # Entry point - imports all functions
│   ├── requirements.txt  # Python dependencies (autogenerated)
│   ├── pyproject.toml    # Python project configuration
│   ├── api/              # API endpoints (organized by feature)
│   │   ├── __init__.py
│   │   ├── health.py        # Health check endpoint
│   │   ├── entities.py      # Entity CRUD operations
│   │   ├── reviews.py       # Create review endpoint
│   │   ├── get_reviews.py   # Get reviews endpoint
│   │   ├── delete_review.py # Delete review endpoint
│   │   └── vote_review.py   # Vote on review endpoint
│   ├── triggers/         # Firestore event triggers
│   │   ├── __init__.py
│   │   └── update_rating.py # Auto-update entity ratings
│   └── utils/            # Utility functions
│       ├── __init__.py
│       └── logger.py     # Structured logging utility
└── README.md
```

## Prerequisites

Before getting started, ensure you have the following installed:

1. **Python 3.11 or higher** (Python 3.13 recommended)
   ```bash
   python3 --version
   ```

2. **Node.js and npm** (for Firebase CLI)
   ```bash
   node --version
   npm --version
   ```

3. **Firebase CLI**
   ```bash
   npm install -g firebase-tools
   ```

4. **uv** (Python package installer - optional but recommended)
   ```bash
   pip install uv
   ```

## Getting Started

### 1. Clone the Repository

```bash
git clone <repository-url>
cd RateMyNUS/backend
```

### 2. Firebase Setup

#### Login to Firebase
```bash
firebase login
```

#### Initialize Firebase Project (if not already done)
```bash
firebase init
```

Select:
- Functions
- Python as the language
- Use existing project or create new one

#### Set Active Project
```bash
firebase use <your-project-id>
```

### 3. Install Dependencies

Navigate to the functions directory:
```bash
cd functions
```

#### Using uv (recommended):
```bash
uv pip install -r requirements.txt
```

#### Using pip:
```bash
pip install -r requirements.txt
```

#### Or install from pyproject.toml:
```bash
uv pip compile pyproject.toml -o requirements.txt
uv pip install -r requirements.txt
```

### 4. Configure Environment

Create a `.env` file or set environment variables as needed for your Firebase project.

### 5. Local Development

#### Run Functions Locally

Use the Firebase Emulator Suite to test functions locally:

```bash
# From the backend directory
firebase emulators:start
```

This will start:
- Functions Emulator (default: http://localhost:5001)
- Firestore Emulator (if configured)
- Other Firebase services as configured

#### Run with Python Functions Framework (alternative)

```bash
cd functions
functions-framework --target=<function_name> --debug
```

### 6. Development Workflow

1. **Edit Functions**: Make changes to files in `functions/api/`
2. **Test Locally**: Use the Firebase Emulator
3. **Check Logs**: View logs in the emulator UI (http://localhost:4000)
4. **Hot Reload**: The emulator automatically reloads on code changes

### 7. Deploy to Firebase

#### Deploy all functions:
```bash
firebase deploy --only functions
```

#### Deploy specific function:
```bash
firebase deploy --only functions:<function_name>
```

#### Deploy with debug output:
```bash
firebase deploy --only functions --debug
```

## API Endpoints
Entities

#### Get Entities

**Get all entities:**
```
GET /get_entities
```

**Get specific entity by ID:**
```
GET /get_entities?id=C01
```

**Filter by type:**
```
GET /get_entities?type=Canteen
GET /get_entities?type=Dorm
GET /get_entities?type=Classroom
```

**Limit results:**
```
GET /get_entities?limit=10
```

**Response format:**
```json
{
  "count": 16,
  "entities": [
    {
      "id": "C01",
      "name": "The Deck",
      "type": "Canteen",
      "avgRating": 0,
      "ratingCount": 0,
      "tags": ["No Aircon", "FASS", "Halal Options"],
      "location": {
        "latitude": 1.295053,
        "longitude": 103.771760
      },
      "createdAt": "2026-01-17T16:17:38+08:00"
    }
  ]
}
```

### Reviews

#### Create Review

**Create a new review:**
```
POST /create_review
Content-Type: application/json
```

**Request body:**
```json
{
  "authorName": "Bob",
  "description": "Very nice and tasty! The chicken rice is excellent.",
  "entityId": "C01",
  "rating": 4,
  "tags": ["halal", "affordable"],
  "subratings": {
    "taste": 5,
    "valueForMoney": 4,
    "portionSize": 4,
    "hygiene": 5,
    "waitingTime": 3
  }
}
```

**Required fields:**
- `authorName` (string) - Name of the review author
- `description` (string) - Review text
- `entityId` (string) - ID of the entity being reviewed (e.g., C01, D05, CR012)
- `rating` (integer, 0-5) - Rating value between 0 and 5

**Optional fields:**
- `tags` (array of strings) - Tags for the review
- `subratings` (object) - Entity-type-specific subratings (0-5 each)
- `moduleCode` (string) - Required for PROFESSOR reviews (e.g., "CS2040S")

**Subratings by Entity Type:**
- **CANTEEN/FOOD_PLACE**: taste, valueForMoney, portionSize, hygiene, waitingTime
- **DORM**: roomCondition, cleanliness, facilities, community, valueForMoney
- **CLASSROOM**: comfort, visibility, audioClarity, ventilation, powerAndWifi
- **PROFESSOR**: clarity, engagement, approachability, fairness, organisation
- **TOILET**: cleanliness, smell, maintenance, privacy, accessibility

**Success Response (201):**
```json
{
  "message": "Review created successfully",
  "review": {
    "id": "abc123xyz",
    "uuid": "550e8400-e29b-41d4-a716-446655440000",
    "authorName": "Bob",
    "description": "Very nice and tasty!",
    "entityId": "C01",
    "rating": 4,
    "tags": ["halal", "affordable"],
    "subratings": {
      "taste": 5,
      "valueForMoney": 4
    },
    "voteCount": 0,
    "createdAt": "2026-01-17T00:00:00+08:00"
  }
}
```

**Error Responses:**
- `400` - Missing required fields or invalid data
- `404` - Entity with specified ID not found
- `405` - Method not allowed (use POST)
- `500` - Server error

#### Get Reviews

**Get reviews for an entity:**
```
GET /get_reviews?entityId=C01
```

**Query parameters:**
- `entityId` (required) - The entity ID to get reviews for


### Export Entities

Export all entities to a JSON file:
```bash
cd backend/scripts
source ../.venv/bin/activate
GOOGLE_CLOUD_PROJECT=ratemynus python export_entities.py
```

Output will be saved to `backend/data/entities_export_<timestamp>.json`
**Response:**
```json
{
  "entityId": "C01",
  "count": 3,
  "reviews": [
    {
      "id": "abc123",
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "authorName": "Bob",
      "description": "Very nice and tasty!",
      "entityId": "C01",
      "rating": 4,
      "tags": ["halal", "affordable"],
      "subratings": {
        "taste": 5,
        "valueForMoney": 4
      },
      "voteCount": 5,
      "createdAt": "2026-01-17T12:30:45.123Z"
    }
  ]
}
```

Reviews are ordered by newest first (createdAt descending).

#### Vote on Review

**Add a vote to a review:**
```
POST /vote_review?id=review_doc_id
```

**Query parameters:**
- `id` (required) - The review document ID to vote on

**No request body needed.**

**Response:**
```json
{
  "message": "Vote added successfully",
  "review": {
    "id": "abc123",
    "voteCount": 6,
    ...
  }
}
```

#### Delete Review

**Delete a review:**
```
DELETE /delete_review?id=review_doc_id
```

**Query parameters:**
- `id` (required) - The review document ID to delete

**Response:**
```json
{
  "message": "Review deleted successfully",
  "id": "abc123"
}
```

### CORS Support

All endpoints support CORS with the following headers:
- `Access-Control-Allow-Origin: *` (configurable)
- `Access-Control-Allow-Methods: GET, POS
- `500` - Server error

### CORS Support

All endpoints support CORS with the following headers:
## Firestore Triggers

### Auto-Update Entity Ratings

**Function**: `update_entity_rating`  
**Trigger**: Firestore document write (create/update/delete) on `reviews/{reviewId}`

This background function automatically recalculates entity ratings whenever a review is created, updated, or deleted:

1. Extracts `entityId` from the review document
2. Queries all reviews for that entity
3. Calculates average rating and review count
4. Updates the entity document with `avgRating` and `ratingCount`

**Deployment:**
```bash
firebase deploy --only functions:update_entity_rating
```

**First-Time Setup:**

When deploying Firestore triggers for the first time, you may encounter an Eventarc permission error. Wait 5-10 minutes for permissions to propagate, then redeploy.

If the error persists, manually grant permissions:

```bash
# Get your project number
gcloud projects describe ratemynus --format="value(projectNumber)"

# Grant Eventarc Service Agent role (replace PROJECT_NUMBER)
gcloud projects add-iam-policy-binding ratemynus \
  --member="serviceAccount:service-PROJECT_NUMBER@gcp-sa-eventarc.iam.gserviceaccount.com" \
  --role="roles/eventarc.serviceAgent"

# Enable required APIs
gcloud services enable eventarc.googleapis.com
gcloud services enable eventarcpublishing.googleapis.com
```

**Monitoring:**

View trigger logs:
```bash
firebase functions:log --only update_entity_rating
```

The function logs:
- Review creation/update/deletion events
- Entity rating calculations
- Update confirmations with new avgRating and ratingCount- `Access-Control-Allow-Origin: *` (configurable)
- `Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS`
- `Access-Control-Allow-Headers: Content-Type, Authorization`

## Data Seeding

The project includes seed scripts to populate Firestore with initial data.

### Entity ID Prefixes
- **Canteens**: `C01` - `C16` (16 canteens)
- **Dorms**: `D01` - `D16` (16 dormitories)
- **Classrooms**: `CR001` - `CR039` (39 classrooms)

### Seed Canteens
```bash
cd functions
GOOGLE_CLOUD_PROJECT=ratemynus uv run python ../scripts/seed_canteen.py
```

### Seed Dorms
```bash
cd functions
GOOGLE_CLOUD_PROJECT=ratemynus uv run python ../scripts/seed_dorm.py
```

### Seed Classrooms
```bash
cd functions
GOOGLE_CLOUD_PROJECT=ratemynus uv run python ../scripts/seed_classroom.py
```

### Delete All Entities
```bash
cd functions
GOOGLE_CLOUD_PROJECT=ratemynus uv run python ../scripts/delete_entities.py
```
⚠️ **Warning**: Requires typing "DELETE" to confirm.

## Logging

The backend uses structured logging that integrates with Google Cloud Logging.

### Usage in Code

```python
from utils.logger import logger

# Basic logging
logger.info("Message", key="value")
logger.warning("Warning message")
logger.error("Error occurred", error=exception)

# HTTP request/response logging
logger.log_request("GET", "/api/entities", user_id="123")
loggFirestore Indexes

The project requires a composite index for querying reviews. Deploy it with:

```bash
firebase deploy --only firestore:indexes
```

**Configured indexes** (in `firestore.indexes.json`):
- `reviews` collection: `entityId` (ASCENDING) + `createdAt` (DESCENDING)

### er.log_response("GET", "/api/entities", 200, duration_ms=45.2)

# Firestore operations
logger.log_firestore_operation("query", "entities", limit=10)
```

### Log Levels
- **DEBUG**: Detailed information for debugging
- **INFO**: General informational messages
- **WARNING**: Warning messages
- **ERROR**: Error messages with exception details
- **CRITICAL**: Critical issues

### View Logs

**Firebase Console:**
```bash
firebase functions:log
firebase functions:log --only get_entities
firebase functions:log --follow
```

**Google Cloud Console:**
Navigate to Cloud Functions → Select function → Logs tab

## Writing Cloud Functions

Functions are organized in the `functions/api/` directory by feature.

### Adding a New Endpoint

1. **Create a new file** in `functions/api/`:
```python
# functions/api/reviews.py
from firebase_functions import https_fn
from firebase_admin import firestore
import json
from utils.logger import logger

def get_cors_headers():
    """Return CORS headers"""
    return {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
        "Content-Type": "application/json"
    }

@https_fn.on_request()
def get_reviews(req: https_fn.Request) -> https_fn.Response:
    """Get reviews from Firestore"""
    if req.method == "OPTIONS":
        return https_fn.Response("", status=204, headers=get_cors_headers())
    
    logger.log_request(req.method, req.path)
    
    # Your logic here
    
    return https_fn.Response(
        json.dumps({"reviews": []}),
        status=200,
        headers=get_cors_hwritten(document="reviews/{reviewId}")
def on_review_written(event: firestore_fn.Event):
    """Trigger when a review is created, updated, or deleted"""
    before = event.data.before  # Document before change
    after = event.data.after    # Document after change
    
    if after and after.exists:
        # Document was created or updated
        review_data = after.to_dict()
        entity_id = review_data.get('entityId')
        # Process the review
    elif before and before.exists:
        # Document was deleted
        review_data = before.to_dict()
        entity_id = review_data.get('entityId')
        # Handle deletion
```

**Available Firestore Triggers:**
- `@firestore_fn.on_document_created()` - Only on creation
- `@firestore_fn.on_document_updated()` - Only on updates
- `@firestore_fn.on_document_deleted()` - Only on deletion
- `@firestore_fn.on_document_written()` - All operations (create/update/delete)unctions/main.py
from api.reviews import get_reviews
```

3. **Deploy**:
```bash
firebase deploy --only functions:get_reviews
```

### Basic HTTP Function Example

```python
from firebase_functions import https_fn
from firebase_admin import initialize_app

initialize_app()

@https_fn.on_request()
def hello_world(req: https_fn.Request) -> https_fn.Response:
    return https_fn.Response("Hello from RateMyNUS!")
```

### Firestore Query Example

```python
from firebase_admin import firestore

db = firestore.client()
docs = db.collection('entities').where('type', '==', 'Canteen').limit(10).stream()

entities = []
for doc in docs:
    data = doc.to_dict()
    data['id'] = doc.id
    entities.append(data)
```

### Firestore Trigger Example

```python
from firebase_functions import firestore_fn
from firebase_admin import firestore

@firestore_fn.on_document_created(document="reviews/{reviewId}")
def on_review_created(event: firestore_fn.Event):
    # Handle new review creation
    review_data = event.data.to_dict()
    # Process the review
    pass
```

## Configuration

### Global Options

The project uses global options configured in `functions/main.py`:

```python
from firebase_functions.options import set_global_options

set_global_options(
    max_instances=10,           # Max concurrent instances for cost control
    region="asia-southeast1",   # Singapore region for low latency in SEA
    memory=256,                 # Memory per instance (MB)
    timeout_sec=60,             # Function timeout in seconds
    min_instances=0,            # Scale to zero when not in use (cost-effective)
)
```

### Function-specific Options

You can override global settings per function:

```python
@https_fn.on_request(
    max_instances=5,
    memory=512,
    region="asia-southeast1"
)
def resource_intensive_function(req):
    # Function code
    pass
```

### Region Configuration

Functions are deployed to **asia-southeast1** (Singapore) for optimal performance in Southeast Asia.

**Available regions:**
- `asia-southeast1` (Singapore)
- `asia-southeast2` (Jakarta)
- `asia-east1` (Taiwan)
- `asia-northeast1` (Tokyo)

### Firebase Project

Set your active Firebase project:
```bash
firebase use ratemynus
```

View current project:
```bash
firebase use
```

## Testing

### Manual Testing with curl

**Health check:**
```bash
curl https://asia-southeast1-ratemynus.cloudfunctions.net/healthcheck
```

**Get all entities:**
```bash
curl https://asia-southeast1-ratemynus.cloudfunctions.net/get_entities
```

**Get specific entity:**
```bash
curl https://asia-southeast1-ratemynus.cloudfunctions.net/get_entities?id=C01
```

**Filter by type:**
```bash
curl "https://asia-southeast1-ratemynus.cloudfunctions.net/get_entities?type=Canteen"
```

### Local Testing with Emulator

```bash
# Start emulator
firebase emulators:start

# Test locally (replace PROJECT_ID with your project)
curl http://localhost:5001/PROJECT_ID/asia-southeast1/healthcheck
curl http://localhost:5001/PROJECT_ID/asia-southeast1/get_entities
```

### Unit Tests

```bash
cd functions
python -m pytest tests/
```

8. **Eventarc Permission Errors**: When deploying Firestore triggers
   - Wait 5-10 minutes for automatic permission propagation
   - Or manually grant Eventarc Service Agent role (see Firestore Triggers section)
   - Enable required APIs: eventarc.googleapis.com, eventarcpublishing.googleapis.com

### Integration Tests

Use the Firebase Emulator Suite for integration testing:

```bash
firebase emulators:exec --only functions "pytest tests/integration"
```

## Monitoring and Logs

### View Logs in Firebase Console
```bash
firebase functions:log
```

### View Specific Function Logs
```bash
firebase functions:log --only <function_name>
```

### Real-time Logs
```bash
firebase functions:log --follow
```

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure all dependencies are installed
   ```bash
   cd functions
   uv pip install -r requirements.txt
   ```

2. **Permission Errors**: Check Firebase project permissions and authentication
   ```bash
   firebase login --reauth
   ```

3. **Deployment Failures**: Check logs with `--debug` flag
   ```bash
   firebase deploy --only functions --debug
   ```

4. **Python Version Mismatch**: Verify Python version matches `firebase.json`
   ```bash
   python3 --version  # Should be 3.13+
   ```

5. **CORS Errors**: Ensure CORS headers are properly set in responses
   - Check `get_cors_headers()` function in API files
   - Handle OPTIONS preflight requests

6. **Firestore Connection Issues**: Set GOOGLE_CLOUD_PROJECT environment variable
   ```bash
   export GOOGLE_CLOUD_PROJECT=ratemynus
   ```

7. **Seed Script Errors**: Run from the functions directory with project ID
   ```bash
   cd functions
   GOOGLE_CLOUD_PROJECT=ratemynus uv run python ../scripts/seed_canteen.py
   ```

### Delete All Functions

To remove all deployed functions:
```bash
firebase functions:delete healthcheck get_entities --force
```

### View Function URLs

```bash
firebase functions:list
```

## Environment Variables

Set environment variables using Firebase configuration:

```bash
firebase functions:config:set someservice.key="THE API KEY"
```

Access in code:
```python
import os
api_key = os.environ.get('SOMESERVICE_KEY')
```

## Security

- Never commit sensitive data (API keys, credentials)
- Use Firebase Functions Config for secrets
- Implement proper authentication and authorization
- Follow least privilege principle for Firebase Admin SDK

## Performance Tips

1. **Minimize Cold Starts**: Keep functions warm with scheduled pings
2. **Optimize Dependencies**: Only include necessary packages
3. **Use Connection Pooling**: Reuse database connections
4. **Set Appropriate Timeouts**: Configure based on function needs
5. **Monitor Memory Usage**: Adjust memory allocation as needed

## Resources

- [Firebase Functions Python Documentation](https://firebase.google.com/docs/functions/python)
- [Firebase Admin SDK Documentation](https://firebase.google.com/docs/admin/setup)
- [Cloud Functions Best Practices](https://cloud.google.com/functions/docs/bestpractices)

## Support

For issues or questions:
1. Check the [Firebase Documentation](https://firebase.google.com/docs)
2. Review project issues on GitHub
3. Contact the development team

## License

[Add your license information here]
