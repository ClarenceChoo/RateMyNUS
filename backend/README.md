# RateMyNUS Firebase Backend

This is the backend service for RateMyNUS, built with Firebase Cloud Functions and Python. It provides serverless API endpoints for the RateMyNUS platform.

## Tech Stack

- **Runtime**: Python 3.13
- **Framework**: Firebase Functions for Python
- **Cloud Platform**: Google Cloud Functions (Firebase)
- **Key Dependencies**:
  - `firebase-admin` - Firebase Admin SDK
  - `firebase-functions` - Cloud Functions framework
  - `flask` - Web framework
  - `flask-cors` - Cross-Origin Resource Sharing support
  - Google Cloud Services (Firestore, Storage)

## Project Structure

```
backend/
├── firebase.json          # Firebase configuration
├── functions/
│   ├── main.py           # Cloud Functions entry point
│   ├── requirements.txt  # Python dependencies (autogenerated)
│   └── pyproject.toml    # Python project configuration
└── README.md
```

## Prerequisites

Before getting started, ensure you have the following installed:

1. **Python 3.11 or higher** (Python 3.13 recommended)
   ```bash
   python3 --version
   ```

2. **Node.js and npm** (for Firebase CLI)
   ```bash
   node --version
   npm --version
   ```

3. **Firebase CLI**
   ```bash
   npm install -g firebase-tools
   ```

4. **uv** (Python package installer - optional but recommended)
   ```bash
   pip install uv
   ```

## Getting Started

### 1. Clone the Repository

```bash
git clone <repository-url>
cd RateMyNUS/backend
```

### 2. Firebase Setup

#### Login to Firebase
```bash
firebase login
```

#### Initialize Firebase Project (if not already done)
```bash
firebase init
```

Select:
- Functions
- Python as the language
- Use existing project or create new one

#### Set Active Project
```bash
firebase use <your-project-id>
```

### 3. Install Dependencies

Navigate to the functions directory:
```bash
cd functions
```

#### Using uv (recommended):
```bash
uv pip install -r requirements.txt
```

#### Using pip:
```bash
pip install -r requirements.txt
```

#### Or install from pyproject.toml:
```bash
uv pip compile pyproject.toml -o requirements.txt
uv pip install -r requirements.txt
```

### 4. Configure Environment

Create a `.env` file or set environment variables as needed for your Firebase project.

### 5. Local Development

#### Run Functions Locally

Use the Firebase Emulator Suite to test functions locally:

```bash
# From the backend directory
firebase emulators:start
```

This will start:
- Functions Emulator (default: http://localhost:5001)
- Firestore Emulator (if configured)
- Other Firebase services as configured

#### Run with Python Functions Framework (alternative)

```bash
cd functions
functions-framework --target=<function_name> --debug
```

### 6. Development Workflow

1. **Edit Functions**: Make changes to `functions/main.py`
2. **Test Locally**: Use the Firebase Emulator
3. **Check Logs**: View logs in the emulator UI (http://localhost:4000)
4. **Hot Reload**: The emulator automatically reloads on code changes

### 7. Deploy to Firebase

#### Deploy all functions:
```bash
firebase deploy --only functions
```

#### Deploy specific function:
```bash
firebase deploy --only functions:<function_name>
```

#### Deploy with debug output:
```bash
firebase deploy --only functions --debug
```

## Writing Cloud Functions

### Basic HTTP Function Example

```python
from firebase_functions import https_fn
from firebase_admin import initialize_app

initialize_app()

@https_fn.on_request()
def hello_world(req: https_fn.Request) -> https_fn.Response:
    return https_fn.Response("Hello from RateMyNUS!")
```

### Firestore Trigger Example

```python
from firebase_functions import firestore_fn
from firebase_admin import firestore

@firestore_fn.on_document_created(document="reviews/{reviewId}")
def on_review_created(event: firestore_fn.Event):
    # Handle new review creation
    review_data = event.data.to_dict()
    # Process the review
    pass
```

## Configuration

### Global Options

The project uses global options for cost control:

```python
from firebase_functions.options import set_global_options

set_global_options(max_instances=10)
```

### Function-specific Options

You can override global settings per function:

```python
@https_fn.on_request(max_instances=5, memory=256)
def resource_intensive_function(req):
    # Function code
    pass
```

## Testing

### Unit Tests

```bash
cd functions
python -m pytest tests/
```

### Integration Tests

Use the Firebase Emulator Suite for integration testing:

```bash
firebase emulators:exec --only functions "pytest tests/integration"
```

## Monitoring and Logs

### View Logs in Firebase Console
```bash
firebase functions:log
```

### View Specific Function Logs
```bash
firebase functions:log --only <function_name>
```

### Real-time Logs
```bash
firebase functions:log --follow
```

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure all dependencies are installed
   ```bash
   pip install -r requirements.txt
   ```

2. **Permission Errors**: Check Firebase project permissions and authentication
   ```bash
   firebase login --reauth
   ```

3. **Deployment Failures**: Check logs with `--debug` flag
   ```bash
   firebase deploy --only functions --debug
   ```

4. **Python Version Mismatch**: Verify Python version matches `firebase.json`
   ```bash
   python3 --version  # Should be 3.13+
   ```

## Environment Variables

Set environment variables using Firebase configuration:

```bash
firebase functions:config:set someservice.key="THE API KEY"
```

Access in code:
```python
import os
api_key = os.environ.get('SOMESERVICE_KEY')
```

## Security

- Never commit sensitive data (API keys, credentials)
- Use Firebase Functions Config for secrets
- Implement proper authentication and authorization
- Follow least privilege principle for Firebase Admin SDK

## Performance Tips

1. **Minimize Cold Starts**: Keep functions warm with scheduled pings
2. **Optimize Dependencies**: Only include necessary packages
3. **Use Connection Pooling**: Reuse database connections
4. **Set Appropriate Timeouts**: Configure based on function needs
5. **Monitor Memory Usage**: Adjust memory allocation as needed

## Resources

- [Firebase Functions Python Documentation](https://firebase.google.com/docs/functions/python)
- [Firebase Admin SDK Documentation](https://firebase.google.com/docs/admin/setup)
- [Cloud Functions Best Practices](https://cloud.google.com/functions/docs/bestpractices)

## Support

For issues or questions:
1. Check the [Firebase Documentation](https://firebase.google.com/docs)
2. Review project issues on GitHub
3. Contact the development team

## License

[Add your license information here]
